<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon.ico">
  <title>Schedule Settings</title>
  <link href="/style-root.css" rel="stylesheet">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.1/css/all.css">
  <style>
    @font-face {font-family: "SegUI";src: url("/SegUIVar.woff2");}
    body {font-family: "SegUI",sans-serif;overflow: hidden;user-select:none;}
    .modal {position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgb(0,0,0);background-color:rgba(0,0,0,0.4);}
    .alert-box {font-size:16px;width:80vw;max-width:25em;padding:3em 1.8em;border-radius:0.5em;box-shadow:1.6em 2.2em 4em rgba(0,0,0,0.5);background-color:#eeeeee;position:absolute;transform:translate(-50%,-50%);top:50%;left:50%;z-index:2;}
    #footer {background-color: #eeeeee;} #toosmall {display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);}
    @media (prefers-color-scheme: dark) {.alert-box{background-color:#111111;box-shadow:1.6em 2.2em 4em rgba(50,50,50,0.5);} #footer {background-color: #222222 !important;}}
    button {font-family: "SegUI",sans-serif;}
    @media screen and (max-width: 307px) {#wrapper {display: none;} #toosmall {display: block;}}
    @media screen and (max-height: 449px) {#wrapper {display: none;} #toosmall {display: block;}}

    #footer {display: none;} /* Remove line to restore original "Done" button */
  </style>
  <script>

    let saveSettings = () => {}
      document.addEventListener("DOMContentLoaded", () => {
        function fixMissingSettings() {
          let Settings = {}
          let xhr = new XMLHttpRequest();
          xhr.open('GET', '/defaultSettings.json');
          xhr.responseType = 'json';
          xhr.send();
          xhr.onload = function () {
            Settings = xhr.response;
            let SavedSettings = JSON.parse(window.localStorage.getItem("settings"));
            if (SavedSettings){
              for (const obj in Settings) {
                
                if (SavedSettings[obj] === undefined){
                  console.log(obj, " is missing!");
                  SavedSettings[obj] = Settings[obj];
                }
                
              }

              SavedSettings.font.values = Settings.font.values;
            }
            else {
                SavedSettings = Settings;
            }
            window.localStorage.setItem("settings", JSON.stringify(SavedSettings));
            console.log("Fixed possible missing settings!");
            start();
          }
        }

        fixMissingSettings(); 

        function start() {
        
        let periodNameElements = [];
        for (let i = 1; i < 8; i++){
          periodNameElements.push(document.querySelector("#period"+i+"Name"));
        }
        
        let Settings = {};

        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/defaultSettings.json');
        xhr.responseType = 'json';
        xhr.send();

        xhr.onload = function () {
          Settings = xhr.response;
          document.querySelector("#ThemeDropdown").addEventListener("change", () => {
            saveSettings();
          });
          document.querySelector("#showSeconds").addEventListener("change", () => {
            saveSettings();
          });
          for (let i = 0; i < periodNameElements.length; i++){
            periodNameElements[i].addEventListener("change", () => {
              saveSettings();
            });
          }
          document.querySelector("#DefaultLunchDropdown").addEventListener("change", () => {
            saveSettings();
          });
          
          document.querySelector("#showRing").addEventListener("change", () => {
            saveSettings();
          });
          
          
          
        }

        saveSettings = () => {
          
          Settings.theme = document.querySelector("#ThemeDropdown").value;
          Settings.showSeconds = document.querySelector("#showSeconds").checked;
          Settings.periodNames.period1 = periodNameElements[0].value;
          Settings.periodNames.period2 = periodNameElements[1].value;
          Settings.periodNames.period3 = periodNameElements[2].value; 
          Settings.periodNames.period4 = periodNameElements[3].value;
          Settings.periodNames.period5 = periodNameElements[4].value;
          Settings.periodNames.period6 = periodNameElements[5].value;
          Settings.periodNames.period7 = periodNameElements[6].value;
          Settings.defaultLunch = document.querySelector("#DefaultLunchDropdown").value;
          Settings.showTimeRemainingRing = document.querySelector("#showRing").checked;
          Settings.font.value = document.querySelector("#font").value;
          window.localStorage.setItem("settings", JSON.stringify(Settings));
          
        }
      
        let loadedSettings = {};
        if (window.localStorage.getItem("settings") === null) {
          let xhr2 = new XMLHttpRequest();
          xhr2.open('GET', '/defaultSettings.json');
          xhr2.responseType = 'json';
          xhr2.send();
          xhr2.onload = function () {
            loadedSettings = xhr2.response;
            loadSettings(loadedSettings);
          }
        }
        else {
          loadedSettings = JSON.parse(window.localStorage.getItem("settings"));
          loadSettings(loadedSettings);
        }

        function loadSettings(LoadSettings) {
          let fontDropdown = document.getElementById("font");
          for (let i = 0; i < LoadSettings.font.values.length; i++){
            let fontOption = document.createElement("option");
            fontOption.innerText = LoadSettings.font.values[i].name;
            fontOption.value = LoadSettings.font.values[i].id;
            fontDropdown.appendChild(fontOption);
          }

          // theme
          switch (LoadSettings.theme) {
            case "light":
              document.querySelector("#ThemeDropdown").selectedIndex = 0;
              break;
            case "dark":
              document.querySelector("#ThemeDropdown").selectedIndex = 1;
              break;
          }
          // showSeconds
          switch (LoadSettings.showSeconds){
            case true:
              document.querySelector("#showSeconds").checked = true;
              break;
            case false:
              document.querySelector("#showSeconds").checked = false;
              break;
          }
          
          
          periodNameElements[0].value = LoadSettings.periodNames.period1;
          periodNameElements[1].value = LoadSettings.periodNames.period2;
          periodNameElements[2].value = LoadSettings.periodNames.period3;
          periodNameElements[3].value = LoadSettings.periodNames.period4;
          periodNameElements[4].value = LoadSettings.periodNames.period5;
          periodNameElements[5].value = LoadSettings.periodNames.period6;
          periodNameElements[6].value = LoadSettings.periodNames.period7;
          
          switch (LoadSettings.defaultLunch) {
            case "A Lunch":
              document.querySelector("#DefaultLunchDropdown").selectedIndex = 0;
              break;
            case "B Lunch":
              document.querySelector("#DefaultLunchDropdown").selectedIndex = 1;
              break;
          }
          
          // showRing
          switch (LoadSettings.showTimeRemainingRing){
            case true:
              document.querySelector("#showRing").checked = true;
              break;
            case false:
              document.querySelector("#showRing").checked = false;
              break;
          }

          for (let i = 0; i < LoadSettings.font.values.length; i++){
            if (LoadSettings.font.values[i].id === LoadSettings.font.value){
              
                document.getElementById("font").selectedIndex = i;
              break;
              
              
            }
          }

        }
      
      }


      });

    function resetSettings(alert) {
      if (alert === false) {
        window.localStorage.removeItem("settings");
        resetSettings("wait");
      } else if (alert === "cancel") {
        document.getElementById("alert").setAttribute("hidden","true");
      } else if (alert === "wait") {
        document.getElementById("alert-content").innerHTML = '<p style="text-align: center; font-size: 1.3em; font-weight: 600; letter-spacing: 0.3px;">Reset Settings</p><p style="text-align: center; font-size: 0.8em;">Resetting settings...</p>';
        window.location.reload();
      } else {
        document.getElementById("alert").removeAttribute("hidden");
      }
    }
    function onDone() {
      saveSettings();
      try {
        window.close();
      } catch (e) {
        console.warn(e);
      }
    }
  </script>
</head>

<body style="margin: 0px;">
  <div id="wrapper">
    <header>
      <nav style="margin-top: 0px; margin-left: 0px; margin-right: 0px;">
        <ul class="navbar">
          <li id="navbutton1" class="navbutton"><a class="nolink" style="border:0;">Schedule Settings</a></li>
          <li class="navbutton" style="float:right">
          <a onclick="onDone()">Done</a></li>
        </ul>
      </nav>
    </header><br>
    <main style="position: fixed; top: 49px;">
      <div style="margin-bottom: 40px; height: 91vh; overflow-y: scroll; width: 100vw;">
        <div style="margin: 8px;">
          <h2 style="margin-top: 10px; margin-bottom: 10px;">Display</h2>
          <h3 style="margin-top: 0; margin-bottom: 0;">Theme</h3>
          <select name="Theme" id="ThemeDropdown" style="width:100px; height:30px; text-align: center; font-size:15px;">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <div>
            <p style="margin-top:0px; margin-bottom: 10px; font-weight: 900;"><label for="showSeconds">Show Seconds</label> 
            <input style="margin-left: 1px; width:15px; height:15px; float: left; margin-right: 10px; margin-top: 3px;" id="showSeconds" type="checkbox"></p>
          </div>
          <div>
            <p style="margin-top:10px; margin-bottom: 10px;  font-weight: 900;"><label for="showRing">Show Time Ring</label> 
            <input style="margin-left: 1px; width:15px; height:15px; float: left; margin-right: 10px; margin-top: 3px;" id="showRing" type="checkbox"></p>
          </div>
          <h3 style="margin-top:10px; margin-bottom: 10px;">Font</h3>
          <select name="Font" id="font" style="width:100px; height:30px; text-align: center; font-size:15px;">
          </select>
          <h2 style="margin-top:10px; margin-bottom: 10px;">Period Names</h2>
          <label for="period1Name">Period 1:</label>
          <input type="text" id="period1Name" placeholder="Period 1"><br>
          <label for="period2Name">Period 2:</label>
          <input type="text" id="period2Name" placeholder="Period 2"><br>
          <label for="period3Name">Period 3:</label>
          <input type="text" id="period3Name" placeholder="Period 3"><br>
          <label for="period4Name">Period 4:</label>
          <input type="text" id="period4Name" placeholder="Period 4"><br>
          <label for="period5Name">Period 5:</label>
          <input type="text" id="period5Name" placeholder="Period 5"><br>
          <label for="period6Name">Period 6:</label>
          <input type="text" id="period6Name" placeholder="Period 6"><br>
          <label for="period7Name">Period 7:</label>
          <input type="text" id="period7Name" placeholder="Period 7"><br>
          <h2 style="margin-top:10px; margin-bottom: 10px;">Default Lunch</h2>
          <select name="Default Lunch" id="DefaultLunchDropdown" style="width:100px; height:30px; text-align: center; font-size:15px;">
            <option>A Lunch</option>
            <option>B Lunch</option>
          </select>
          <h2 style="margin-bottom: 0px;">Danger Zone</h2>
          <h5 style="margin-top: 0px;">Using these settings may drastically change the look of the bell schedule.</h5>
          <button onclick="resetSettings(true);">Reset Settings</button>
        </div>
      </div>
    </main>
    <div id="padding" style="width: 100vw; height: 100px;"></div>
    <footer style="position: fixed; bottom: 0; left:0; width: 100vw; height: 40px;" id="footer">
      <button id="done" style=" position:fixed; left: 50vw; transform: translate(-55%, 14%);"
        onclick="saveSettings();window.close();">Done</button>
    </footer>
  </div>
  <div id="toosmall">
    <h3>Your device's screen is too small.</h3>
    <p>To use the settings page, please make your window larger, or use a larger display.</p>
  </div>
  <div id="alert" class="modal" hidden>
    <div class="alert-box">
      <div id="alert-content" class="details">
        <p style="text-align: center; font-size: 1.3em; font-weight: 600; letter-spacing: 0.3px;">Reset Settings</p>
        <p style="text-align: center; font-size: 0.8em;">
          You have requested to reset your settings. If you continue, your theme and bell schedule settings will be removed. Are you sure you want to reset your settings?
        </p>
        <p style="text-align:center;"><button onclick="resetSettings(false)">Yes</button> <button onclick="resetSettings('cancel')">No</button></p>
      </div>
    </div>
  </div>
  <context-menu menu-id="settings">
    <menu-item role="reload" onclick="document.querySelector('[menu-id=settings]').style.display = 'none'; location.reload()"><i class="fa-solid fa-arrow-rotate-right"></i>Reload</menu-item>
    <menu-item role="back" onclick="document.querySelector('[menu-id=settings]').style.display = 'none'; saveSettings(); window.close();"><i class="fa-solid fa-floppy-disk"></i>Save and Close</menu-item>
    <menu-item role="forward" onclick="document.querySelector('[menu-id=settings]').style.display = 'none'; resetSettings(true);"><i class="fa-solid fa-trash-can-xmark"></i>Reset Settings</menu-item>
  </context-menu>
</body>

<script src="/commons.js"></script>
<script>
  setRightClick(document.querySelector("body"), document.querySelector("[menu-id=settings]"));
</script>

</html>